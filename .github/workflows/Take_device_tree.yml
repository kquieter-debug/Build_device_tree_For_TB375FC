name: Build Complete Device Tree (dtb + dtbo) For LineageOS
on:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: read

jobs:
  build-full-device-tree:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Step 1 - æ£€å‡ºä»“åº“æºç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Step 2 - å®‰è£…ä¾èµ–ã€çº¯PyPI extract-dtb + æ ¸å¿ƒç¼–è¯‘å·¥å…·ã€‘
        run: |
          echo "âš¡ å®‰è£…ç³»ç»Ÿä¾èµ–å’ŒPyPIå·¥å…·"
          sudo apt update -y && sudo apt install -y --no-install-recommends \
            device-tree-compiler python3-pip python3-setuptools lz4
          # çº¯PyPIå®‰è£…extract-dtbï¼Œä½ çš„æ ¸å¿ƒè¦æ±‚
          sudo pip3 install --upgrade pip
          sudo pip3 install extract-dtb
          # éªŒè¯å®‰è£…æˆåŠŸï¼Œæ— æŠ¥é”™åˆ™ç»§ç»­
          extract-dtb --version
          echo "âœ… æ‰€æœ‰ä¾èµ–å®‰è£…å®Œæˆï¼Œæ— ä»»ä½•é—®é¢˜"

      - name: Step 3 - æå–+è§£åŒ…+ç¼–è¯‘ ä¸»dtb + dtbo å…¨è®¾å¤‡æ ‘æ–‡ä»¶ã€æ ¸å¿ƒæ­¥éª¤ã€‘
        run: |
          # å®šä¹‰ä½ çš„æ‰€æœ‰æ–‡ä»¶è·¯å¾„ï¼ˆå®Œå…¨åŒ¹é…ä½ çš„ä»“åº“ç»“æ„ï¼Œæ— éœ€ä¿®æ”¹ï¼‰
          WORK_DIR=${{ github.workspace }}
          VENDOR_BOOT_DTB=$WORK_DIR/vendor_boot/dtb
          DTBO_FILE=$WORK_DIR/dtbo/dts/dts.0
          OUTPUT_DIR=$WORK_DIR/device_tree
          # åˆ›å»ºè®¾å¤‡æ ‘è¾“å‡ºç›®å½•ï¼Œè‡ªåŠ¨åˆ›å»ºå­ç›®å½•å½’ç±»
          mkdir -p $OUTPUT_DIR/main_dtb $OUTPUT_DIR/overlay_dtbo

          # ===== å‰ç½®æ ¡éªŒï¼šç¡®è®¤ä½ çš„ä¸¤ä¸ªæ ¸å¿ƒæ–‡ä»¶éƒ½å­˜åœ¨ =====
          if [ ! -f "$VENDOR_BOOT_DTB" ]; then
            echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ°ä¸»è®¾å¤‡æ ‘æ–‡ä»¶ -> $VENDOR_BOOT_DTB"
            exit 1
          fi
          if [ ! -f "$DTBO_FILE" ]; then
            echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ°dtboå åŠ å±‚æ–‡ä»¶ -> $DTBO_FILE"
            exit 1
          fi
          echo "âœ… æ‰€æœ‰æ ¸å¿ƒè®¾å¤‡æ ‘æ–‡ä»¶æ ¡éªŒé€šè¿‡ï¼Œå¼€å§‹æå–..."

          # ===== å¤„ç† ä¸»è®¾å¤‡æ ‘ vendor_boot/dtb =====
          echo "ğŸ”§ å¼€å§‹è§£åŒ…ä¸»è®¾å¤‡æ ‘ vendor_boot/dtb (PyPI extract-dtb)"
          # è§£åŒ…æ‰“åŒ…å¼dtbé•œåƒï¼Œæå–æ‰€æœ‰ç‹¬ç«‹dtbæ–‡ä»¶åˆ°ä¸»ç›®å½•
          extract-dtb -o $OUTPUT_DIR/main_dtb $VENDOR_BOOT_DTB
          # å¯¹æ‰€æœ‰è§£åŒ…åçš„dtbç¼–è¯‘ä¿®å¤ï¼Œç”ŸæˆLineageOSå…¼å®¹çš„dtb+dts
          for dtb_file in $OUTPUT_DIR/main_dtb/*.dtb; do
            if [ -f "$dtb_file" ]; then
              dtc -I dtb -O dts -o "${dtb_file%.dtb}.dts" "$dtb_file"
              dtc -I dts -O dtb -o "$dtb_file" "${dtb_file%.dtb}.dts"
            fi
          done

          # ===== å¤„ç† å åŠ å±‚è®¾å¤‡æ ‘ dtbo/dts/dts.0 =====
          echo "ğŸ”§ å¤„ç†å åŠ å±‚è®¾å¤‡æ ‘ dtbo/dts/dts.0"
          # æ ¸å¿ƒï¼šå°†å®‰å“æ ‡å‡†çš„dts.0è½¬ä¸ºLineageOSç¼–è¯‘ç›´æ¥å¯ç”¨çš„ dtbo.img + dtbo.dtb + dtbo.dts
          cp -f $DTBO_FILE $OUTPUT_DIR/overlay_dtbo/dtbo_raw
          dtc -I dtb -O dts -o $OUTPUT_DIR/overlay_dtbo/dtbo.dts $OUTPUT_DIR/overlay_dtbo/dtbo_raw
          dtc -I dts -O dtb -o $OUTPUT_DIR/overlay_dtbo/dtbo.dtb $OUTPUT_DIR/overlay_dtbo/dtbo.dts
          # ç”Ÿæˆç¼–è¯‘æœ€å¸¸ç”¨çš„ dtbo.img æ ¼å¼ï¼Œä¸€æ­¥åˆ°ä½
          mkdtboimg cfg_create $OUTPUT_DIR/overlay_dtbo/dtbo.img $OUTPUT_DIR/overlay_dtbo/dtbo.dtb

          # ===== æ ¡éªŒæå–ç»“æœ =====
          MAIN_DTB_CNT=$(ls -1 $OUTPUT_DIR/main_dtb/*.dtb 2>/dev/null | wc -l)
          DTBO_CNT=$(ls -1 $OUTPUT_DIR/overlay_dtbo/*.dtb $OUTPUT_DIR/overlay_dtbo/*.img 2>/dev/null | wc -l)
          if [ $MAIN_DTB_CNT -eq 0 ] || [ $DTBO_CNT -eq 0 ]; then
            echo "âŒ é”™è¯¯ï¼šè®¾å¤‡æ ‘æå–å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶å®Œæ•´æ€§"
            exit 1
          fi
          echo "âœ… å®Œæ•´è®¾å¤‡æ ‘æ„å»ºå®Œæˆï¼æå–ä¸»dtbæ–‡ä»¶ $MAIN_DTB_CNT ä¸ªï¼Œdtboæ–‡ä»¶ $DTBO_CNT ä¸ª"
          ls -lh $OUTPUT_DIR/main_dtb/
          ls -lh $OUTPUT_DIR/overlay_dtbo/

          # ç”Ÿæˆæ–‡ä»¶æ¸…å•ï¼Œæ–¹ä¾¿åç»­æŸ¥é˜…
          ls -R $OUTPUT_DIR > $OUTPUT_DIR/DEVICE_TREE_FULL_LIST.txt

      - name: Step 4 - è‡ªåŠ¨æ¨é€è®¾å¤‡æ ‘åˆ°ä»“åº“
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add device_tree/
          git commit -m "build: full device tree (dtb+dtbo) for LineageOS $(date +'%Y-%m-%d %H:%M:%S')" -a || echo "â„¹ï¸ æ— æ–°æ–‡ä»¶å˜æ›´ï¼Œè·³è¿‡æäº¤"
          git push origin HEAD:${{ github.ref }}
          echo "âœ… æ‰€æœ‰è®¾å¤‡æ ‘æ–‡ä»¶å·²æˆåŠŸæ¨é€è‡³ä»“åº“ï¼"