name: Build Complete Device Tree (dtb + dtbo) For LineageOS
on:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: read

jobs:
  build-full-device-tree:
    runs-on: ubuntu-24.04  # é€‚é…å½“å‰ runner ç¯å¢ƒ
    timeout-minutes: 10
    steps:
      - name: Step 1 - æ£€å‡ºä»“åº“æºç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Step 2 - å®‰è£…ä¾èµ–ã€çº¯PyPI extract-dtb + æ ¸å¿ƒå·¥å…·ã€‘
        run: |
          echo "âš¡ å®‰è£…ç³»ç»Ÿä¾èµ–å’ŒPyPIå·¥å…·ï¼ˆé€‚é…Ubuntu 24.04ï¼‰"
          # å®‰è£…ç³»ç»Ÿä¾èµ–ï¼Œ--no-install-recommends å‡å°‘å†—ä½™åŒ…
          sudo apt update -y && sudo apt install -y --no-install-recommends \
            device-tree-compiler \
            python3-pip \
            python3-setuptools \
            lz4 \
            android-sdk-libsparse-utils  # æ–°å¢ï¼šç¡®ä¿ mkdtboimg å·¥å…·å¯ç”¨
          
          # å…³é”®ä¿®å¤ï¼šä¸å‡çº§pipï¼Œç›´æ¥ç”¨ç³»ç»Ÿé¢„è£…pip3å®‰è£…extract-dtbï¼ˆé¿å…å¸è½½æŠ¥é”™ï¼‰
          echo "ğŸ“¦ ç”¨ç³»ç»Ÿpip3å®‰è£…extract-dtbï¼ˆæ— éœ€å‡çº§ï¼‰"
          sudo pip3 install extract-dtb
          
          # éªŒè¯å®‰è£…æˆåŠŸ
          echo "âœ… extract-dtb ç‰ˆæœ¬ï¼š$(extract-dtb --version)"
          echo "âœ… æ‰€æœ‰ä¾èµ–å®‰è£…å®Œæˆï¼Œæ— ç³»ç»Ÿæƒé™å†²çª"

      - name: Step 3 - æå–+è§£åŒ…+ç¼–è¯‘ ä¸»dtb + dtbo å…¨è®¾å¤‡æ ‘æ–‡ä»¶
        run: |
          # å®šä¹‰è·¯å¾„ï¼ˆå®Œå…¨åŒ¹é…ä½ çš„ä»“åº“ç»“æ„ï¼‰
          WORK_DIR=${{ github.workspace }}
          VENDOR_BOOT_DTB=$WORK_DIR/vendor_boot/dtb
          DTBO_FILE=$WORK_DIR/dtbo/dts/dts.0
          OUTPUT_DIR=$WORK_DIR/device_tree
          mkdir -p $OUTPUT_DIR/main_dtb $OUTPUT_DIR/overlay_dtbo

          # å‰ç½®æ ¡éªŒæ ¸å¿ƒæ–‡ä»¶
          if [ ! -f "$VENDOR_BOOT_DTB" ]; then
            echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ°ä¸»è®¾å¤‡æ ‘ -> $VENDOR_BOOT_DTB"
            exit 1
          fi
          if [ ! -f "$DTBO_FILE" ]; then
            echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ°dtboæ–‡ä»¶ -> $DTBO_FILE"
            exit 1
          fi

          # 1. è§£åŒ…ä¸»è®¾å¤‡æ ‘ï¼ˆvendor_boot/dtbï¼‰
          echo "ğŸ”§ è§£åŒ…ä¸»è®¾å¤‡æ ‘ï¼ˆPyPI extract-dtbï¼‰"
          extract-dtb -o $OUTPUT_DIR/main_dtb $VENDOR_BOOT_DTB
          # ç¼–è¯‘ä¿®å¤ä¸»dtbï¼ˆç”Ÿæˆdts+dtbï¼‰
          for dtb_file in $OUTPUT_DIR/main_dtb/*.dtb; do
            [ -f "$dtb_file" ] && dtc -I dtb -O dts -o "${dtb_file%.dtb}.dts" "$dtb_file"
            [ -f "$dtb_file" ] && dtc -I dts -O dtb -o "$dtb_file" "${dtb_file%.dtb}.dts"
          done

          # 2. å¤„ç†dtboï¼ˆdtbo/dts/dts.0ï¼‰
          echo "ğŸ”§ å¤„ç†dtboå åŠ å±‚æ–‡ä»¶"
          cp -f $DTBO_FILE $OUTPUT_DIR/overlay_dtbo/dtbo_raw
          # è½¬æ¢ä¸ºLineageOSå…¼å®¹æ ¼å¼
          dtc -I dtb -O dts -o $OUTPUT_DIR/overlay_dtbo/dtbo.dts $OUTPUT_DIR/overlay_dtbo/dtbo_raw
          dtc -I dts -O dtb -o $OUTPUT_DIR/overlay_dtbo/dtbo.dtb $OUTPUT_DIR/overlay_dtbo/dtbo.dts
          # ç”Ÿæˆå¯ç›´æ¥åˆ·å…¥çš„dtbo.img
          mkdtboimg cfg_create $OUTPUT_DIR/overlay_dtbo/dtbo.img $OUTPUT_DIR/overlay_dtbo/dtbo.dtb

          # 3. æ ¡éªŒç»“æœ
          MAIN_CNT=$(ls -1 $OUTPUT_DIR/main_dtb/*.dtb 2>/dev/null | wc -l)
          DTBO_CNT=$(ls -1 $OUTPUT_DIR/overlay_dtbo/*.dtb $OUTPUT_DIR/overlay_dtbo/*.img 2>/dev/null | wc -l)
          if [ $MAIN_CNT -eq 0 ] || [ $DTBO_CNT -eq 0 ]; then
            echo "âŒ è®¾å¤‡æ ‘æå–å¤±è´¥ï¼Œè¯·æ£€æŸ¥æºæ–‡ä»¶å®Œæ•´æ€§"
            exit 1
          fi
          echo "âœ… æ„å»ºå®Œæˆï¼ä¸»dtbï¼š$MAIN_CNT ä¸ªï¼Œdtboæ–‡ä»¶ï¼š$DTBO_CNT ä¸ª"
          ls -lh $OUTPUT_DIR/main_dtb/
          ls -lh $OUTPUT_DIR/overlay_dtbo/

          # ç”Ÿæˆæ–‡ä»¶æ¸…å•
          ls -R $OUTPUT_DIR > $OUTPUT_DIR/DEVICE_TREE_FULL_LIST.txt

      - name: Step 4 - æ¨é€è®¾å¤‡æ ‘åˆ°ä»“åº“
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add device_tree/
          git commit -m "build: full device tree (dtb+dtbo) for LineageOS $(date +'%Y-%m-%d %H:%M:%S')" -a || echo "â„¹ï¸ æ— æ–°æ–‡ä»¶å˜æ›´"
          git push origin HEAD:${{ github.ref }}
          echo "âœ… è®¾å¤‡æ ‘å·²æˆåŠŸæ¨é€ï¼"