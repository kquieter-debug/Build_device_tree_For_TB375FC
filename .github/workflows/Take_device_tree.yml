name: Build Device Tree from Unpacked vendor_boot
on:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: read

jobs:
  build-device-tree:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Install Dependencies
        run: |
          sudo apt update -y
          sudo apt install -y device-tree-compiler  # ä»…ä¿ç•™æ ¸å¿ƒdtcå·¥å…·

      - name: Extract & Build Device Tree
        run: |
          # åˆå§‹åŒ–ç›®å½•
          mkdir -p $GITHUB_WORKSPACE/device_tree
          DT_DIR=$GITHUB_WORKSPACE/device_tree
          VENDOR_BOOT_DIR=$GITHUB_WORKSPACE/vendor_boot

          # æ ¡éªŒvendor_bootä¸‹çš„dtbæ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f "$VENDOR_BOOT_DIR/dtb" ]; then
            echo "âŒ é”™è¯¯ï¼švendor_bootæ–‡ä»¶å¤¹ä¸‹æœªæ‰¾åˆ°dtbæ–‡ä»¶ï¼"
            exit 1
          fi

          # ç›´æ¥å¤åˆ¶dtbæ–‡ä»¶åˆ°è®¾å¤‡æ ‘ç›®å½•
          echo "ğŸ“¤ å¤åˆ¶dtbæ–‡ä»¶..."
          cp $VENDOR_BOOT_DIR/dtb $DT_DIR/device.dtb

          # ç¼–è¯‘ä¸ºLineageOSå…¼å®¹çš„dts+dtb
          echo "âš™ï¸ ç¼–è¯‘è®¾å¤‡æ ‘..."
          dtc -I dtb -O dts -o $DT_DIR/device.dts $DT_DIR/device.dtb
          dtc -I dts -O dtb -o $DT_DIR/device.dtb $DT_DIR/device.dts

          # ç”Ÿæˆæ¸…å•
          ls -l $DT_DIR > $DT_DIR/DEVICE_TREE_LIST.txt
          echo "âœ… è®¾å¤‡æ ‘æ„å»ºå®Œæˆï¼æ–‡ä»¶ï¼š$DT_DIR/device.dtbã€$DT_DIR/device.dts"

      - name: Push Device Tree to Repository
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add device_tree/
          git commit -m "build(device-tree): from vendor_boot dtb $(date)" -a || echo "âœ… æ— æ–°æ–‡ä»¶"
          git push origin HEAD:${{ github.ref }}
          echo "âœ… è®¾å¤‡æ ‘å·²æ¨é€è‡³ä»“åº“ï¼"