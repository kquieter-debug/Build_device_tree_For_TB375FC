# å·¥ä½œæµåç§°
name: Extract Vendor_Boot & Build Device Tree For LineageOS

# è§¦å‘è§„åˆ™ï¼šæ‰‹åŠ¨è§¦å‘+æ–‡ä»¶æ›´æ–°è‡ªåŠ¨è§¦å‘
on:
  workflow_dispatch:
  push:
    branches: [ main, master ]
    paths:
      - 'Image/vendor_boot.img'

# ========== æƒé™å¯ç”¨ ==========
permissions:
  contents: write        # å…è®¸è¯»å†™ä»“åº“å†…å®¹ã€æ¨é€æ–‡ä»¶
  pull-requests: write   # å…¼å®¹PRæ“ä½œ
  id-token: write        # èº«ä»½ä»¤ç‰Œè®¤è¯
  actions: read          # è¯»å–actionè¿è¡ŒçŠ¶æ€

jobs:
  extract-and-build-dtb:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout current repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # ========== å¼ºåˆ¶é…ç½®èº«ä»½è®¤è¯ ==========
          token: ${{ github.token }}
          persist-credentials: true

      - name: Install all required dependencies & tools (ä¿®å¤Ubuntu24.04ä¾èµ–)
        run: |
          echo "ğŸ”§ å¼€å§‹å®‰è£…ç¼–è¯‘å’Œè§£åŒ…æ‰€éœ€ä¾èµ–..."
          sudo apt update -y && sudo apt upgrade -y
          sudo apt install -y git wget curl unzip lzip tar gcc g++ make python3 python3-pip flex bison bc rsync
          sudo apt install -y abootimg android-sdk-libsparse-utils
          sudo apt install -y device-tree-compiler libfdt-dev
          echo "âœ… æ‰€æœ‰ä¾èµ–å®‰è£…å®Œæˆï¼"

      - name: Download Android boot/unpack tools (æ— æƒé™å…‹éš†é—®é¢˜ï¼Œç”¨å‹ç¼©åŒ…ä¸‹è½½)
        run: |
          echo "ğŸ”§ ä¸‹è½½å®‰å“é•œåƒè§£åŒ…ä¸“ç”¨å·¥å…·..."
          wget --timeout=30 --tries=3 https://github.com/corsicanu/extract-dtb/archive/refs/heads/master.zip -O $HOME/extract-dtb.zip
          unzip -q $HOME/extract-dtb.zip -d $HOME && mv $HOME/extract-dtb-master $HOME/extract-dtb
          wget --timeout=30 --tries=3 https://github.com/osm0sis/mkbootimg/archive/refs/heads/master.zip -O $HOME/mkbootimg.zip
          unzip -q $HOME/mkbootimg.zip -d $HOME && mv $HOME/mkbootimg-master $HOME/mkbootimg
          wget --timeout=30 --tries=3 https://github.com/topjohnwu/Magisk/releases/latest/download/magiskboot -O $HOME/magiskboot
          chmod +x $HOME/magiskboot $HOME/extract-dtb/extract-dtb.py
          echo "âœ… è§£åŒ…å·¥å…·ä¸‹è½½å®Œæˆï¼"
        timeout-minutes: 5

      - name: Check vendor_boot.img & Create work directories
        run: |
          echo "ğŸ” æ£€æŸ¥Imageç›®å½•ä¸‹çš„vendor_boot.imgæ–‡ä»¶..."
          if [ ! -f "Image/vendor_boot.img" ]; then
            echo "âŒ ERROR: Image/vendor_boot.img æ–‡ä»¶ä¸å­˜åœ¨ï¼è¯·ç¡®è®¤æ–‡ä»¶è·¯å¾„æ­£ç¡®"
            exit 1
          fi
          mkdir -p work/vendor_boot_unpack work/dts_source work/device_tree_out
          echo "âœ… æ–‡ä»¶æ£€æŸ¥é€šè¿‡ï¼Œå·¥ä½œç›®å½•åˆ›å»ºå®Œæˆï¼"

      - name: Unpack vendor_boot.img completely (all partitions)
        run: |
          echo "âš™ï¸ å¼€å§‹è§£åŒ… vendor_boot.img é•œåƒæ–‡ä»¶..."
          cd work/vendor_boot_unpack
          cp $GITHUB_WORKSPACE/Image/vendor_boot.img ./
          $HOME/magiskboot unpack vendor_boot.img
          $HOME/extract-dtb/extract-dtb.py vendor_boot.img -o $GITHUB_WORKSPACE/work/dts_source/
          if [ $(ls $GITHUB_WORKSPACE/work/dts_source/ | wc -l) -eq 0 ]; then
            echo "âŒ ERROR: è§£åŒ…å¤±è´¥ï¼Œæœªæå–åˆ°ä»»ä½•dtbæ–‡ä»¶ï¼"
            exit 1
          fi
          echo "âœ… vendor_boot.img è§£åŒ…å®Œæˆï¼å·²æå–åˆ°dtbäºŒè¿›åˆ¶æ–‡ä»¶"

      - name: Decompile DTB to DTS & Build Complet Device Tree (LineageOS Ready)
        run: |
          echo "âš™ï¸ å¼€å§‹åç¼–è¯‘dtbæ–‡ä»¶ä¸ºdtsæºç ï¼Œå¹¶æ„å»ºæ ‡å‡†è®¾å¤‡æ ‘..."
          cd $GITHUB_WORKSPACE/work/dts_source
          for dtb_file in *.dtb; do
            echo "ğŸ”§ åç¼–è¯‘: $dtb_file â†’ ${dtb_file%.dtb}.dts"
            dtc -I dtb -O dts -o ${dtb_file%.dtb}.dts $dtb_file
          done
          mkdir -p $GITHUB_WORKSPACE/device_tree
          cp -r $GITHUB_WORKSPACE/work/dts_source/* $GITHUB_WORKSPACE/device_tree/
          [ -d "$GITHUB_WORKSPACE/work/vendor_boot_unpack/ramdisk" ] && cp -r $GITHUB_WORKSPACE/work/vendor_boot_unpack/ramdisk $GITHUB_WORKSPACE/device_tree/
          [ -f "$GITHUB_WORKSPACE/work/vendor_boot_unpack/config" ] && cp $GITHUB_WORKSPACE/work/vendor_boot_unpack/config $GITHUB_WORKSPACE/device_tree/
          echo "âœ… è®¾å¤‡æ ‘æ„å»ºå®Œæˆï¼ç›®å½•: device_tree/ ï¼ˆç›´æ¥å…¼å®¹LineageOSï¼‰"

      - name: Clean redundant files & Optimize device tree structure
        run: |
          echo "ğŸ§¹ æ¸…ç†å†—ä½™æ–‡ä»¶ï¼Œä¼˜åŒ–è®¾å¤‡æ ‘ç›®å½•ç»“æ„..."
          rm -rf $GITHUB_WORKSPACE/work $HOME/*.zip $HOME/extract-dtb $HOME/mkbootimg $HOME/magiskboot
          find $GITHUB_WORKSPACE/device_tree -name "*.tmp" -delete
          find $GITHUB_WORKSPACE/device_tree -name "*.bak" -delete
          echo "âœ… æ¸…ç†å®Œæˆï¼Œè®¾å¤‡æ ‘ç›®å½•çº¯å‡€å¯ç”¨ï¼"

      - name: Commit & Push Device Tree (========== å®Œæ•´èº«ä»½å£°æ˜ + å¼ºåˆ¶è®¤è¯æ¨é€ ==========)
        run: |
          echo "ğŸ“¤ å¼€å§‹æäº¤è®¾å¤‡æ ‘æ–‡ä»¶åˆ°ä»“åº“..."
          # ========== è§£å†³ã€Œworkflowä¸æ¸…æ¥šä½ æ˜¯è°ã€çš„æ ¸å¿ƒèº«ä»½å£°æ˜ ==========
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global credential.helper store
          echo "https://github.com:${{ github.actor }}:${{ github.token }}" > ~/.git-credentials
          
          # æäº¤æ–‡ä»¶
          git add device_tree/
          git commit -m "build(device-tree): extract and build from vendor_boot.img âœ…" -m "Source: Image/vendor_boot.img" || echo "â„¹ï¸ æ— æ–°çš„è®¾å¤‡æ ‘æ–‡ä»¶éœ€è¦æäº¤"
          
          # ========== é‡ç‚¹ï¼šå¼ºåˆ¶ä½¿ç”¨è®¤è¯ä»¤ç‰Œæ¨é€ï¼Œå½»åº•è§£å†³æ¨é€è¢«æ‹’ ==========
          git push https://${{ github.token }}@github.com/${{ github.repository }}.git HEAD:${GITHUB_REF#refs/heads/} --force-with-lease
          echo "âœ… è®¾å¤‡æ ‘å·²æˆåŠŸæ¨é€åˆ°ä»“åº“ï¼ç›®å½•ï¼šdevice_tree/"