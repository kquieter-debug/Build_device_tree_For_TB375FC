name: Build Android Device Tree from Unpacked vendor_boot
on:
  workflow_dispatch:
  # push:
  #   branches: [ main, master ]
  #   paths: [ 'vendor_boot/**' ]

permissions:
  contents: write
  pull-requests: read

jobs:
  build-device-tree:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Install Dependencies & PyPI Tools
        run: |
          echo "ğŸ“¦ å®‰è£…åŸºç¡€ä¾èµ–..."
          sudo apt update -y
          sudo apt install -y git build-essential device-tree-compiler android-sdk-libsparse-utils

          echo "ğŸ“¦ å®‰è£…PyPIç‰ˆextract-dtb..."
          sudo pip install extract-dtb
          extract-dtb --version  # éªŒè¯å®‰è£…æˆåŠŸ

      - name: Extract & Build Device Tree
        run: |
          # åˆå§‹åŒ–ç›®å½•
          mkdir -p $GITHUB_WORKSPACE/device_tree
          DT_DIR=$GITHUB_WORKSPACE/device_tree
          VENDOR_BOOT_DIR=$GITHUB_WORKSPACE/vendor_boot

          # æ ¡éªŒvendor_bootå­˜åœ¨
          if [ ! -d "$VENDOR_BOOT_DIR" ]; then
            echo "âŒ æœªæ‰¾åˆ°vendor_bootæ–‡ä»¶å¤¹ï¼"
            exit 1
          fi

          # æå–dtb/dtboæ–‡ä»¶
          echo "ğŸ“¤ æå–è®¾å¤‡æ ‘æ–‡ä»¶..."
          find $VENDOR_BOOT_DIR -name "*.dtb" -o -name "*.dtbo" | xargs cp -t $DT_DIR
          extract-dtb -o $DT_DIR $VENDOR_BOOT_DIR  # ä½¿ç”¨PyPIç‰ˆå·¥å…·æå–

          # ç¼–è¯‘ä¿®å¤è®¾å¤‡æ ‘
          echo "âš™ï¸ ç¼–è¯‘å…¼å®¹LineageOSçš„è®¾å¤‡æ ‘..."
          for dtb_file in $DT_DIR/*.dtb; do
            [ -f "$dtb_file" ] && dtc -I dtb -O dts -o "${dtb_file%.dtb}.dts" "$dtb_file"
            [ -f "$dtb_file" ] && dtc -I dts -O dtb -o "$dtb_file" "${dtb_file%.dtb}.dts"
          done

          ls -l $DT_DIR > $DT_DIR/DEVICE_TREE_LIST.txt
          echo "âœ… è®¾å¤‡æ ‘æ„å»ºå®Œæˆï¼"

      - name: Push Device Tree to Repository
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add device_tree/
          git commit -m "build(device-tree): auto build from vendor_boot $(date)" -a || echo "âœ… æ— æ–°æ–‡ä»¶"
          git push origin HEAD:${{ github.ref }}
          echo "âœ… è®¾å¤‡æ ‘å·²æ¨é€ï¼"