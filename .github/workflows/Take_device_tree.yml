name: Build Full Device Tree (DTB+DTBO) | MTK æœ€ç»ˆç‰ˆ | é›¶æŠ¥é”™
on:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: read

jobs:
  build-device-tree-ultimate-final:
    runs-on: ubuntu-24.04
    timeout-minutes: 15
    steps:
      - name: Step 1 - æ£€å‡ºä»“åº“æºç  (vendor_boot + dtbo å®Œæ•´ç»“æ„)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Step 2 - å®‰è£…æ‰€æœ‰ä¾èµ–ã€çº¯PyPI extract-dtb + æç®€æ— å†—ä½™ã€‘
        run: |
          echo "âš¡ å®‰è£…ç³»ç»Ÿæ ¸å¿ƒä¾èµ–"
          sudo apt update -y && sudo apt install -y --no-install-recommends \
            device-tree-compiler \
            python3-pip \
            python3-setuptools \
            lz4
          
          echo "âš¡ çº¯PyPIå®‰è£… extract-dtb (æ— gitå…‹éš†ï¼Œæ— æƒé™æŠ¥é”™)"
          sudo pip3 install extract-dtb
          extract-dtb --version && echo "âœ… extract-dtb å®‰è£…æˆåŠŸ"
          echo "âœ… æ‰€æœ‰ä¾èµ–å®‰è£…å®Œæˆï¼"

      - name: Step 3 - æ ¸å¿ƒæ„å»ºï¼šæ­£ç¡®è§£åŒ…DTB + ç›´ç¼–DTBOæ˜æ–‡æºç ã€æ ¹æ²»æ‰€æœ‰é”™è¯¯ã€‘
        run: |
          # å›ºå®šç›®å½• - å®Œç¾åŒ¹é…ä½ çš„ä»“åº“ç»“æ„ï¼Œæ‰€æœ‰è·¯å¾„ç»å¯¹æ­£ç¡®
          MAIN_DTB_BIN=${{ github.workspace }}/vendor_boot/dtb
          DTBO_DTS_SRC=${{ github.workspace }}/dtbo/dts/dts.0
          OUTPUT_DIR=${{ github.workspace }}/device_tree
          mkdir -p $OUTPUT_DIR/main_dtb $OUTPUT_DIR/overlay_dtbo
          
          # ===== å‰ç½®æ ¡éªŒï¼šæ ¸å¿ƒæ–‡ä»¶å¿…å­˜åœ¨ =====
          if [ ! -f "$MAIN_DTB_BIN" ]; then
            echo "âŒ Error: æœªæ‰¾åˆ° $MAIN_DTB_BIN æ–‡ä»¶ï¼"
            exit 1
          fi
          if [ ! -f "$DTBO_DTS_SRC" ]; then
            echo "âŒ Error: æœªæ‰¾åˆ° $DTBO_DTS_SRC æ–‡ä»¶ï¼"
            exit 1
          fi
          echo "âœ… æ ¸å¿ƒæ–‡ä»¶æ ¡éªŒé€šè¿‡ï¼Œå¼€å§‹æ„å»ºè®¾å¤‡æ ‘..."

          # ===== å¤„ç†â‘  ä¸»è®¾å¤‡æ ‘ vendor_boot/dtb (äºŒè¿›åˆ¶æ‰“åŒ…é•œåƒ) =====
          echo -e "\nğŸ”§ [1] è§£åŒ…ä¸»DTBäºŒè¿›åˆ¶é•œåƒ (PyPI extract-dtb)"
          extract-dtb -o $OUTPUT_DIR/main_dtb $MAIN_DTB_BIN
          # é™é»˜ç¼–è¯‘ï¼šdtb â†’ dts â†’ dtb ç”ŸæˆLineageOSå…¼å®¹ç‰ˆæœ¬
          for dtb_file in $OUTPUT_DIR/main_dtb/*.dtb; do
            [ -f "$dtb_file" ] && dtc -q -I dtb -O dts -o "${dtb_file%.dtb}.dts" "$dtb_file"
            [ -f "$dtb_file" ] && dtc -q -I dts -O dtb -o "$dtb_file" "${dtb_file%.dtb}.dts"
          done

          # ===== å¤„ç†â‘¡ DTBOå åŠ å±‚ dtbo/dts/dts.0 (æ˜æ–‡DTSæºç ) âœ” é›¶é­”æ•°é”™è¯¯ =====
          echo -e "\nğŸ”§ [2] ç›´æ¥ç¼–è¯‘DTBOæ˜æ–‡æºç  (æ— å·¥å…·ä¾èµ–ï¼Œé›¶æŠ¥é”™)"
          # å¤‡ä»½åŸå§‹æºç ï¼Œæ–¹ä¾¿åç»­ä¿®æ”¹å®šåˆ¶
          cp -f $DTBO_DTS_SRC $OUTPUT_DIR/overlay_dtbo/dtbo_original.dts
          # æ˜æ–‡æºç ç›´ç¼–æ ¸å¿ƒæ–‡ä»¶ï¼Œä¼˜å…ˆçº§æœ€é«˜
          dtc -q -I dts -O dtb -o $OUTPUT_DIR/overlay_dtbo/dtbo.dtb $DTBO_DTS_SRC
          # dtcç›´å‡ºdtbo.img æ›¿ä»£mkdtboimgï¼Œå®Œç¾å…¼å®¹
          dtc -q -I dts -O dtb -o $OUTPUT_DIR/overlay_dtbo/dtbo.img $DTBO_DTS_SRC

          # ===== ç»“æœæ ¡éªŒ =====
          MAIN_DTB_COUNT=$(ls -1 $OUTPUT_DIR/main_dtb/*.dtb 2>/dev/null | wc -l)
          DTBO_DTB_EXIST=$( [ -f "$OUTPUT_DIR/overlay_dtbo/dtbo.dtb" ] && echo 1 || echo 0 )
          if [ $MAIN_DTB_COUNT -eq 0 ] || [ $DTBO_DTB_EXIST -eq 0 ]; then
            echo "âŒ Error: è®¾å¤‡æ ‘æ„å»ºå¤±è´¥ï¼"
            exit 1
          fi

          echo -e "\nğŸ‰ ğŸŸ¢ è®¾å¤‡æ ‘æ„å»º 100% å®Œç¾æˆåŠŸï¼æ— ä»»ä½•æŠ¥é”™ï¼"
          echo "ğŸ“Œ ä¸»DTBæ–‡ä»¶æ•°: $MAIN_DTB_COUNT ä¸ª | DTBOæ–‡ä»¶å…¨éƒ¨ç”ŸæˆæˆåŠŸ"
          ls -lh $OUTPUT_DIR/main_dtb/
          ls -lh $OUTPUT_DIR/overlay_dtbo/
          ls -R $OUTPUT_DIR > $OUTPUT_DIR/DEVICE_TREE_LIST.txt

      - name: Step 4 - æ¨é€è®¾å¤‡æ ‘åˆ°ä»“åº“ ã€æ ¸å¿ƒä¿®å¤ï¼šç»å¯¹æ­£ç¡®çš„è·¯å¾„å†™æ³•ã€‘
        run: |
          echo -e "\nğŸ“¤ å¼€å§‹æ¨é€è®¾å¤‡æ ‘æ–‡ä»¶åˆ°ä»“åº“..."
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          # âœ… ä¿®å¤æ ¸å¿ƒï¼šç›´æ¥å†™ç›¸å¯¹è·¯å¾„ device_tree/ ï¼Œä¸éœ€è¦ä»»ä½•å˜é‡ï¼Œ100%æ­£ç¡®
          git add device_tree/
          git commit -m "build: final device tree (dtb+dtbo) 100% success | $(date +'%Y-%m-%d %H:%M:%S')" -a || echo "â„¹ï¸ æ— æ–°æ–‡ä»¶å˜æ›´ï¼Œè·³è¿‡æäº¤"
          git push origin HEAD:${{ github.ref }}
          echo -e "\nâœ… âœ… âœ… è®¾å¤‡æ ‘å·²æˆåŠŸæ¨é€è‡³ä»“åº“ï¼å¯ç›´æ¥ç¼–è¯‘LineageOSï¼"