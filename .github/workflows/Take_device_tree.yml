name: Build Full Device Tree (DTB+DTBO) | MTK æ˜æ–‡DTS.0 Fix | PyPI Only
on:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: read

jobs:
  build-device-tree-final-perfect:
    runs-on: ubuntu-24.04
    timeout-minutes: 15
    steps:
      - name: Step 1 - Checkout Repo (å«vendor_boot + dtboæ–‡ä»¶å¤¹)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Step 2 - å®‰è£…æ‰€æœ‰ä¾èµ– (çº¯PyPI extract-dtb + æ ¸å¿ƒç¼–è¯‘å·¥å…·)
        run: |
          echo "âš¡ Install all dependencies (PyPI extract-dtb only)"
          sudo apt update -y && sudo apt install -y --no-install-recommends \
            device-tree-compiler \
            python3-pip \
            python3-setuptools \
            lz4 \
            android-sdk-libsparse-utils
          # çº¯PyPIå®‰è£…extract-dtbï¼Œæ— å‡çº§ã€æ— gitå…‹éš†ï¼Œç»å¯¹æ— æƒé™æŠ¥é”™
          sudo pip3 install extract-dtb
          # éªŒè¯å®‰è£…æˆåŠŸ
          extract-dtb --version
          echo "âœ… All dependencies installed successfully!"

      - name: Step 3 - æ ¸å¿ƒæ„å»ºï¼šåˆ†ç±»å‹å¤„ç† DTB(äºŒè¿›åˆ¶) + DTBO(æ˜æ–‡DTSæºç ) âœ” æ ¹æ²»é­”æ•°é”™è¯¯
        run: |
          # å›ºå®šç›®å½• - å®Œç¾åŒ¹é…ä½ çš„ä»“åº“ç»“æ„ï¼Œæ— éœ€ä»»ä½•ä¿®æ”¹
          WORK_DIR=${{ github.workspace }}
          # ä¸»è®¾å¤‡æ ‘ï¼šäºŒè¿›åˆ¶æ‰“åŒ…é•œåƒ
          MAIN_DTB_BIN=$WORK_DIR/vendor_boot/dtb
          # DTBOå åŠ å±‚ï¼šæ˜æ–‡DTSæºç æ–‡ä»¶ (ä½ çš„æ ¸å¿ƒå‘ç°ï¼)
          DTBO_DTS_SRC=$WORK_DIR/dtbo/dts/dts.0
          # è¾“å‡ºç›®å½•ï¼šè‡ªåŠ¨åˆ›å»ºåˆ†ç±»æ–‡ä»¶å¤¹
          OUTPUT_DIR=$WORK_DIR/device_tree
          mkdir -p $OUTPUT_DIR/main_dtb $OUTPUT_DIR/overlay_dtbo
          
          # ===== å‰ç½®æ ¡éªŒï¼šå¿…é¡»å­˜åœ¨ä¸¤ä¸ªæ ¸å¿ƒæ–‡ä»¶ =====
          if [ ! -f "$MAIN_DTB_BIN" ]; then
            echo "âŒ Error: $MAIN_DTB_BIN ä¸»DTBäºŒè¿›åˆ¶æ–‡ä»¶ä¸å­˜åœ¨ï¼"
            exit 1
          fi
          if [ ! -f "$DTBO_DTS_SRC" ]; then
            echo "âŒ Error: $DTBO_DTS_SRC DTBOæ˜æ–‡æºç æ–‡ä»¶ä¸å­˜åœ¨ï¼"
            exit 1
          fi
          echo "âœ… æ‰€æœ‰æ ¸å¿ƒæ–‡ä»¶æ ¡éªŒé€šè¿‡ï¼Œå¼€å§‹æ„å»º..."

          # ===== å¤„ç†â‘  ä¸»è®¾å¤‡æ ‘ vendor_boot/dtb (äºŒè¿›åˆ¶æ‰“åŒ…é•œåƒ) =====
          echo -e "\nğŸ”§ [1] è§£åŒ… ä¸»DTBäºŒè¿›åˆ¶æ‰“åŒ…é•œåƒ (PyPI extract-dtb)"
          extract-dtb -o $OUTPUT_DIR/main_dtb $MAIN_DTB_BIN
          # é™é»˜ç¼–è¯‘ï¼šäºŒè¿›åˆ¶dtb â†’ dtsæºç  â†’ æ ‡å‡†dtbï¼Œå…¼å®¹LineageOS
          for dtb_file in $OUTPUT_DIR/main_dtb/*.dtb; do
            if [ -f "$dtb_file" ]; then
              dtc -q -I dtb -O dts -o "${dtb_file%.dtb}.dts" "$dtb_file"
              dtc -q -I dts -O dtb -o "$dtb_file" "${dtb_file%.dtb}.dts"
            fi
          done

          # ===== å¤„ç†â‘¡ DTBOå åŠ å±‚ dtbo/dts/dts.0 (æ˜æ–‡DTSæºç ) âœ” æ ¸å¿ƒä¿®å¤ï¼Œæ ¹æ²»é­”æ•°é”™è¯¯ =====
          echo -e "\nğŸ”§ [2] ç›´æ¥ç¼–è¯‘ DTBOæ˜æ–‡DTSæºç  (æ— éœ€è§£åŒ…ï¼Œç›´æ¥ç¼–è¯‘ï¼Œæ— é­”æ•°é”™è¯¯)"
          # å¤åˆ¶æ˜æ–‡æºç åˆ°è¾“å‡ºç›®å½•ï¼Œæ–¹ä¾¿åç»­ä¿®æ”¹å®šåˆ¶
          cp -f $DTBO_DTS_SRC $OUTPUT_DIR/overlay_dtbo/dtbo_original.dts
          # æ ¸å¿ƒå‘½ä»¤ï¼šæ˜æ–‡DTSæºç  â†’ æ ‡å‡†DTBOäºŒè¿›åˆ¶æ–‡ä»¶ (dtbo.dtb)ï¼Œæ— ä»»ä½•é­”æ•°é—®é¢˜ï¼
          dtc -q -I dts -O dtb -o $OUTPUT_DIR/overlay_dtbo/dtbo.dtb $DTBO_DTS_SRC
          # ç”Ÿæˆå¯ç›´æ¥åˆ·å…¥/ç¼–è¯‘çš„dtbo.img (LineageOSç¼–è¯‘å¿…å¤‡)
          mkdtboimg cfg_create $OUTPUT_DIR/overlay_dtbo/dtbo.img $OUTPUT_DIR/overlay_dtbo/dtbo.dtb

          # ===== ç»“æœæ ¡éªŒï¼šç¡®ä¿ç”Ÿæˆæœ‰æ•ˆæ–‡ä»¶ =====
          MAIN_DTB_COUNT=$(ls -1 $OUTPUT_DIR/main_dtb/*.dtb 2>/dev/null | wc -l)
          DTBO_VALID=$( [ -f "$OUTPUT_DIR/overlay_dtbo/dtbo.dtb" ] && [ -f "$OUTPUT_DIR/overlay_dtbo/dtbo.img" ] && echo 1 || echo 0 )
          
          if [ $MAIN_DTB_COUNT -eq 0 ]; then
            echo "âŒ Error: ä¸»DTBè§£åŒ…å¤±è´¥ï¼Œæœªç”Ÿæˆä»»ä½•dtbæ–‡ä»¶ï¼"
            exit 1
          fi
          if [ $DTBO_VALID -eq 0 ]; then
            echo "âŒ Error: DTBOæºç ç¼–è¯‘å¤±è´¥ï¼Œæœªç”Ÿæˆdtbo.dtb/imgï¼"
            exit 1
          fi

          # ===== è¾“å‡ºæ„å»ºæˆåŠŸä¿¡æ¯ =====
          echo -e "\nğŸ‰ âœ… è®¾å¤‡æ ‘æ„å»º 100% æˆåŠŸï¼æ— ä»»ä½•æŠ¥é”™ï¼"
          echo "ğŸ“Œ ä¸»è®¾å¤‡æ ‘æ–‡ä»¶æ•°: $MAIN_DTB_COUNT ä¸ª"
          echo "ğŸ“Œ DTBOæ–‡ä»¶å·²ç”Ÿæˆ: dtbo.dtb + dtbo.img (æ˜æ–‡æºç ç¼–è¯‘)"
          echo -e "\nğŸ“‚ ä¸»DTBæ–‡ä»¶åˆ—è¡¨:"
          ls -lh $OUTPUT_DIR/main_dtb/
          echo -e "\nğŸ“‚ DTBOæ–‡ä»¶åˆ—è¡¨:"
          ls -lh $OUTPUT_DIR/overlay_dtbo/
          # ç”Ÿæˆæ–‡ä»¶æ¸…å•
          ls -R $OUTPUT_DIR > $OUTPUT_DIR/DEVICE_TREE_COMPLETE_LIST.txt

      - name: Step 4 - è‡ªåŠ¨æ¨é€è®¾å¤‡æ ‘åˆ°ä»“åº“ (æ— å˜æ›´åˆ™è·³è¿‡)
        run: |
          echo -e "\nğŸ“¤ å‡†å¤‡æ¨é€è®¾å¤‡æ ‘æ–‡ä»¶åˆ°ä»“åº“..."
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add $WORK_DIR/device_tree/
          # æ— æ–‡ä»¶å˜æ›´åˆ™é™é»˜è·³è¿‡ï¼Œä¸æŠ¥é”™
          git commit -m "build: perfect device tree (DTB bin + DTBO plain DTS) $(date +'%Y-%m-%d %H:%M:%S')" -a || echo "â„¹ï¸ æ— æ–°çš„è®¾å¤‡æ ‘æ–‡ä»¶å˜æ›´ï¼Œè·³è¿‡æäº¤"
          git push origin HEAD:${{ github.ref }}
          echo "âœ… è®¾å¤‡æ ‘æ–‡ä»¶å·²æˆåŠŸæ¨é€è‡³ä»“åº“ï¼"