name: Build Complete Device Tree (dtb + dtbo) For LineageOS
on:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: read

jobs:
  build-full-device-tree:
    runs-on: ubuntu-24.04
    timeout-minutes: 10
    steps:
      - name: Step 1 - æ£€å‡ºä»“åº“æºç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Step 2 - å®‰è£…ä¾èµ–
        run: |
          echo "âš¡ å®‰è£…ç³»ç»Ÿä¾èµ–å’ŒPyPIå·¥å…·"
          sudo apt update -y && sudo apt install -y --no-install-recommends \
            device-tree-compiler python3-pip python3-setuptools lz4 android-sdk-libsparse-utils
          sudo pip3 install extract-dtb
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

      - name: Step 3 - æå–+ç¼–è¯‘è®¾å¤‡æ ‘ï¼ˆå±è”½è‰¯æ€§è­¦å‘Šï¼‰
        run: |
          WORK_DIR=${{ github.workspace }}
          VENDOR_BOOT_DTB=$WORK_DIR/vendor_boot/dtb
          DTBO_FILE=$WORK_DIR/dtbo/dts/dts.0
          OUTPUT_DIR=$WORK_DIR/device_tree
          mkdir -p $OUTPUT_DIR/main_dtb $OUTPUT_DIR/overlay_dtbo

          # æ ¡éªŒæ ¸å¿ƒæ–‡ä»¶
          [ ! -f "$VENDOR_BOOT_DTB" ] && echo "âŒ æœªæ‰¾åˆ°ä¸»dtb" && exit 1
          [ ! -f "$DTBO_FILE" ] && echo "âŒ æœªæ‰¾åˆ°dtboæ–‡ä»¶" && exit 1

          # è§£åŒ…ä¸»dtbï¼ˆå±è”½è­¦å‘Šï¼‰
          echo "ğŸ”§ è§£åŒ…ä¸»è®¾å¤‡æ ‘"
          extract-dtb -o $OUTPUT_DIR/main_dtb $VENDOR_BOOT_DTB
          for dtb_file in $OUTPUT_DIR/main_dtb/*.dtb; do
            [ -f "$dtb_file" ] && dtc -W no-warning -I dtb -O dts -o "${dtb_file%.dtb}.dts" "$dtb_file"
            [ -f "$dtb_file" ] && dtc -W no-warning -I dts -O dtb -o "$dtb_file" "${dtb_file%.dtb}.dts"
          done

          # å¤„ç†dtboï¼ˆå±è”½è­¦å‘Šï¼‰
          echo "ğŸ”§ å¤„ç†dtboå åŠ å±‚"
          cp -f $DTBO_FILE $OUTPUT_DIR/overlay_dtbo/dtbo_raw
          dtc -W no-warning -I dtb -O dts -o $OUTPUT_DIR/overlay_dtbo/dtbo.dts $OUTPUT_DIR/overlay_dtbo/dtbo_raw
          dtc -W no-warning -I dts -O dtb -o $OUTPUT_DIR/overlay_dtbo/dtbo.dtb $OUTPUT_DIR/overlay_dtbo/dtbo.dts
          mkdtboimg cfg_create $OUTPUT_DIR/overlay_dtbo/dtbo.img $OUTPUT_DIR/overlay_dtbo/dtbo.dtb

          # æ ¡éªŒç»“æœ
          MAIN_CNT=$(ls -1 $OUTPUT_DIR/main_dtb/*.dtb 2>/dev/null | wc -l)
          DTBO_CNT=$(ls -1 $OUTPUT_DIR/overlay_dtbo/*.dtb $OUTPUT_DIR/overlay_dtbo/*.img 2>/dev/null | wc -l)
          [ $MAIN_CNT -eq 0 ] || [ $DTBO_CNT -eq 0 ] && echo "âŒ ç”Ÿæˆå¤±è´¥" && exit 1
          echo "âœ… æ„å»ºå®Œæˆï¼ä¸»dtbï¼š$MAIN_CNT ä¸ªï¼Œdtboæ–‡ä»¶ï¼š$DTBO_CNT ä¸ª"
          ls -lh $OUTPUT_DIR/main_dtb/
          ls -lh $OUTPUT_DIR/overlay_dtbo/
          ls -R $OUTPUT_DIR > $OUTPUT_DIR/DEVICE_TREE_FULL_LIST.txt

      - name: Step 4 - æ¨é€è‡³ä»“åº“
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add device_tree/
          git commit -m "build: full device tree (dtb+dtbo) $(date +'%Y-%m-%d %H:%M:%S')" -a || echo "â„¹ï¸ æ— æ–°å˜æ›´"
          git push origin HEAD:${{ github.ref }}
          echo "âœ… æ¨é€æˆåŠŸï¼"