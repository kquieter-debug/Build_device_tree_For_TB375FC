# å·¥ä½œæµåç§°ï¼Œå¯è‡ªå®šä¹‰
name: æ„å»ºTB375FCè®¾å¤‡æ ‘
# è§¦å‘è§„åˆ™ï¼šä¸¤ç§æ–¹å¼å¯é€‰ï¼ŒæŒ‰éœ€ä¿ç•™/åˆ é™¤
on:
  # æ–¹å¼1ï¼šæ‰‹åŠ¨è§¦å‘ï¼ˆæ¨èï¼Œæœ€å¸¸ç”¨ï¼‰ï¼Œåœ¨GitHubä»“åº“Actionsé¡µé¢ç‚¹å‡»ã€ŒRun workflowã€å³å¯æ‰§è¡Œ
  workflow_dispatch:
  # æ–¹å¼2ï¼šå½“ä»“åº“æœ‰pushæäº¤æ—¶è‡ªåŠ¨è§¦å‘ï¼ˆæ¯”å¦‚æ›´æ–°vendor_bootæ–‡ä»¶åè‡ªåŠ¨é‡æ„è®¾å¤‡æ ‘ï¼‰ï¼Œå¯é€‰å¼€å¯
  # push:
  #   branches: [ main, master ]
  #   paths: [ 'vendor_boot/**' ] # ä»…å½“vendor_bootæ–‡ä»¶å¤¹å†…å®¹å˜æ›´æ—¶è§¦å‘

# æƒé™é…ç½®ï¼šå¿…é¡»é…ç½®ï¼Œç”¨äºå°†æ„å»ºå¥½çš„è®¾å¤‡æ ‘æ¨é€åˆ°ä»“åº“
permissions:
  contents: write
  pull-requests: read

# å·¥ä½œæµæ ¸å¿ƒä»»åŠ¡
jobs:
  build-device-tree:
    # è¿è¡Œç¯å¢ƒï¼šUbuntu 22.04ï¼ˆGitHub Actionå®˜æ–¹æ¨èï¼Œå®‰å“ç¼–è¯‘æœ€ä½³å…¼å®¹ç¯å¢ƒï¼‰
    runs-on: ubuntu-22.04
    steps:
      # æ­¥éª¤1ï¼šæ£€å‡ºå½“å‰ä»“åº“ä»£ç ï¼ˆåŒ…å«æ ¹ç›®å½•çš„vendor_bootæ–‡ä»¶å¤¹ï¼‰
      - name: æ£€æŸ¥ä»“åº“å†…çš„vendor_bootæ–‡ä»¶å¤¹
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      # æ­¥éª¤2ï¼šå®‰è£…æ‰€æœ‰ä¾èµ–å·¥å…·ï¼ˆå®‰å“è®¾å¤‡æ ‘æ„å»º+ç¼–è¯‘å¿…å¤‡ï¼Œä¸€é”®å®‰è£…æ— é—æ¼ï¼‰
      - name: å®‰è£…ä¾èµ–
        run: |
          echo "ğŸ“¦ å¼€å§‹å®‰è£…æ„å»ºè®¾å¤‡æ ‘æ‰€éœ€ä¾èµ–..."
          sudo apt update -y && sudo apt upgrade -y
          # åŸºç¡€ä¾èµ–
          sudo apt install -y git build-essential bc bison flex python3 python3-pip libssl-dev liblz4-tool curl wget unzip zip
          # è®¾å¤‡æ ‘æ ¸å¿ƒå·¥å…·ï¼šdtc(è®¾å¤‡æ ‘ç¼–è¯‘å™¨) mkbootimg dtboimg_tools
          sudo apt install -y device-tree-compiler android-sdk-libsparse-utils android-sdk-platform-tools
          # å®‰è£…extract-dtbå·¥å…·ï¼ˆä»vendor_bootæå–dtbä¸“ç”¨ï¼‰
          git clone https://github.com/PabloCastellano/extract-dtb.git $HOME/extract-dtb
          chmod +x $HOME/extract-dtb/extract-dtb.py
          sudo cp $HOME/extract-dtb/extract-dtb.py /usr/bin/extract-dtb
          echo "âœ… æ‰€æœ‰ä¾èµ–å·¥å…·å®‰è£…å®Œæˆï¼"

      # æ­¥éª¤3ï¼šåˆ›å»ºè®¾å¤‡æ ‘å­˜æ”¾ç›®å½• + ä»vendor_bootæå–å¹¶æ„å»ºå®Œæ•´è®¾å¤‡æ ‘
      - name: åˆ›å»ºè®¾å¤‡æ ‘å­˜æ”¾ç›®å½•ï¼Œæå–è®¾å¤‡æ ‘
        run: |
          echo "ğŸ”§ å¼€å§‹åˆå§‹åŒ–è®¾å¤‡æ ‘æ„å»ºç¯å¢ƒ..."
          # åˆ›å»ºè®¾å¤‡æ ‘æ ¹ç›®å½•ï¼ˆä»“åº“æ ¹ç›®å½•ç”Ÿæˆï¼Œæ–¹ä¾¿åç»­ç›´æ¥ä½¿ç”¨ï¼‰
          mkdir -p $GITHUB_WORKSPACE/device_tree
          DT_DIR=$GITHUB_WORKSPACE/device_tree
          VENDOR_BOOT_DIR=$GITHUB_WORKSPACE/vendor_boot

          # æ ¡éªŒvendor_bootæ–‡ä»¶å¤¹æ˜¯å¦å­˜åœ¨ï¼ˆé˜²é”™ï¼‰
          if [ ! -d "$VENDOR_BOOT_DIR" ]; then
            echo "âŒ é”™è¯¯ï¼šä»“åº“æ ¹ç›®å½•æœªæ‰¾åˆ° vendor_boot æ–‡ä»¶å¤¹ï¼Œè¯·ç¡®è®¤ä¸Šä¼ å®Œæˆï¼"
            exit 1
          fi

          echo "ğŸ“¤ å¼€å§‹ä»è§£åŒ…çš„vendor_bootæå–dtb/dtboè®¾å¤‡æ ‘æ–‡ä»¶..."
          # æå–vendor_bootå†…æ‰€æœ‰dtb/dtboæ–‡ä»¶åˆ°è®¾å¤‡æ ‘ç›®å½•
          find $VENDOR_BOOT_DIR -name "*.dtb" -o -name "*.dtbo" | xargs cp -t $DT_DIR
          # ä»vendor_bootçš„kernel/ramdiskä¸­æ·±åº¦æå–éšè—çš„dtbæ–‡ä»¶
          extract-dtb $VENDOR_BOOT_DIR -o $DT_DIR

          echo "âš™ï¸ å¼€å§‹ç¼–è¯‘/ä¿®å¤è®¾å¤‡æ ‘æ–‡ä»¶ï¼ˆLineageOSç¼–è¯‘å…¼å®¹ç‰ˆï¼‰..."
          # éå†æ‰€æœ‰dtbæ–‡ä»¶ï¼Œé‡æ–°ç¼–è¯‘ä¸ºæ ‡å‡†dtsæºç +äºŒè¿›åˆ¶dtbï¼ˆè§£å†³å…¼å®¹æ€§é—®é¢˜ï¼‰
          for dtb_file in $DT_DIR/*.dtb; do
            if [ -f "$dtb_file" ]; then
              dtc -I dtb -O dts -o "${dtb_file%.dtb}.dts" "$dtb_file"
              dtc -I dts -O dtb -o "$dtb_file" "${dtb_file%.dtb}.dts"
            fi
          done

          # ç”Ÿæˆè®¾å¤‡æ ‘æ¸…å•æ–‡ä»¶ï¼Œæ–¹ä¾¿åç»­LineageOSç¼–è¯‘è°ƒç”¨
          ls -l $DT_DIR > $DT_DIR/DEVICE_TREE_LIST.txt
          echo "âœ… è®¾å¤‡æ ‘æ„å»ºå®Œæˆï¼æ‰€æœ‰æ–‡ä»¶å·²ä¿å­˜è‡³ï¼š$DT_DIR"

      # æ­¥éª¤4ï¼šè‡ªåŠ¨å°†æ„å»ºå¥½çš„è®¾å¤‡æ ‘æäº¤å¹¶æ¨é€åˆ°å½“å‰ä»“åº“ï¼ˆæ ¸å¿ƒæ­¥éª¤ï¼Œè‡ªåŠ¨ä¿å­˜æˆæœï¼‰
      - name: æ¨é€åˆ°å½“å‰ä»“åº“
        run: |
          echo "ğŸ“¤ å¼€å§‹æäº¤å¹¶æ¨é€è®¾å¤‡æ ‘æ–‡ä»¶åˆ°ä»“åº“..."
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          # æ£€æŸ¥ä»“åº“çŠ¶æ€
          git add device_tree/
          git status
          # æäº¤ä»£ç ï¼ˆå¸¦æ—¶é—´æˆ³ï¼Œæ–¹ä¾¿åŒºåˆ†ç‰ˆæœ¬ï¼‰
          git commit -m "build(device-tree): auto build device tree from vendor_boot $(date +'%Y-%m-%d %H:%M:%S')" -a || echo "âœ… æ— æ–°çš„è®¾å¤‡æ ‘æ–‡ä»¶éœ€è¦æäº¤"
          # æ¨é€åˆ°å½“å‰åˆ†æ”¯
          git push origin HEAD:${{ github.ref }}
          echo "âœ… è®¾å¤‡æ ‘æ–‡ä»¶å·²æˆåŠŸæ¨é€åˆ°ä»“åº“ï¼"