name: Extract Vendor_Boot & Build Device Tree For LineageOS

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]
    paths:
      - 'Image/vendor_boot.img'

permissions:
  contents: write
  pull-requests: write
  id-token: write
  actions: read

jobs:
  extract-and-build-dtb:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout current repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ github.token }}
          persist-credentials: true

<<<<<<< HEAD
      - name: ç²¾ç®€å®‰è£…ä¾èµ–ï¼ˆå«å®Œæ•´æ€§æ ¡éªŒå·¥å…·ï¼‰
        run: |
          echo "ğŸ”§ å®‰è£…æ ¸å¿ƒä¾èµ–+æ ¡éªŒå·¥å…·..."
          sudo apt update -y
          # æ–°å¢libfdt-devï¼ˆæä¾›fdt_check_headeræ ¡éªŒå‡½æ•°ï¼‰
          sudo apt install -y git wget curl unzip lzip tar gcc g++ make flex bison bc rsync \
            abootimg android-sdk-libsparse-utils device-tree-compiler libfdt-dev python3 python3-pip
=======
      - name: Install dependencies & PyPIç‰ˆextract-dtb
        run: |
          echo "ğŸ”§ å®‰è£…ç³»ç»Ÿä¾èµ–+PyPIå·¥å…·..."
          sudo apt update -y && sudo apt upgrade -y
          sudo apt install -y git wget curl unzip lzip tar gcc g++ make flex bison bc rsync
          sudo apt install -y abootimg android-sdk-libsparse-utils device-tree-compiler libfdt-dev
          # å®‰è£…Python+extract-dtb
          sudo apt install -y python3 python3-pip
          sudo pip3 install --upgrade pip
>>>>>>> parent of 75d05e1 (Update Take_device_tree.yml)
          sudo pip3 install extract-dtb
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆï¼"

      - name: ä¸‹è½½ä½ æä¾›çš„Magiskbootï¼ˆx86_64ç‰ˆï¼Œé€‚é…GitHub Actionsç¯å¢ƒï¼‰
        run: |
          echo "ğŸ”§ ä»magoohnji/magiskboot-linuxä¸‹è½½å·¥å…·..."
          # ç›´æ¥ä¸‹è½½x86_64ç‰ˆæœ¬ï¼ˆGitHub Actionsæ˜¯x86_64æ¶æ„ï¼‰
          wget --timeout=30 --tries=3 https://raw.githubusercontent.com/magoohnji/magiskboot-linux/main/x86_64/magiskboot -O $HOME/magiskboot
          chmod +x $HOME/magiskboot
<<<<<<< HEAD
=======
          # éªŒè¯ä¸‹è½½ç»“æœ
>>>>>>> parent of 75d05e1 (Update Take_device_tree.yml)
          if [ ! -f "$HOME/magiskboot" ]; then
            echo "âŒ ERROR: Magiskbootä¸‹è½½å¤±è´¥ï¼"
            exit 1
          fi
          echo "âœ… Magiskbootä¸‹è½½å®Œæˆï¼"

      - name: Check vendor_boot.img & åˆ›å»ºå·¥ä½œç›®å½•
        run: |
          echo "ğŸ” æ£€æŸ¥Imageç›®å½•..."
          if [ ! -f "Image/vendor_boot.img" ]; then
            echo "âŒ ERROR: Image/vendor_boot.imgä¸å­˜åœ¨ï¼"
            exit 1
          fi
          mkdir -p work/vendor_boot_unpack work/dts_source work/device_tree_out
          echo "âœ… æ–‡ä»¶æ£€æŸ¥é€šè¿‡ï¼"

      - name: Unpack vendor_boot.img + æå–dtb
        run: |
          echo "âš™ï¸ è§£åŒ…vendor_boot.img..."
          cd work/vendor_boot_unpack
          cp $GITHUB_WORKSPACE/Image/vendor_boot.img ./
          $HOME/magiskboot unpack vendor_boot.img
<<<<<<< HEAD
=======
          # æå–dtb
>>>>>>> parent of 75d05e1 (Update Take_device_tree.yml)
          extract-dtb -o $GITHUB_WORKSPACE/work/dts_source/ $GITHUB_WORKSPACE/Image/vendor_boot.img
          if [ $(ls $GITHUB_WORKSPACE/work/dts_source/ | wc -l) -eq 0 ]; then
            echo "âŒ ERROR: æœªæå–åˆ°dtbæ–‡ä»¶ï¼"
            exit 1
          fi
          echo "âœ… è§£åŒ…+æå–dtbå®Œæˆï¼"

      - name: ğŸ” ç¬¬ä¸€é‡æ ¡éªŒï¼šDTBæ–‡ä»¶åˆæ³•æ€§ï¼ˆæ£€æŸ¥å¹»æ•°+å¤´éƒ¨ï¼‰
        run: |
          echo "âš™ï¸ éªŒè¯æ‰€æœ‰dtbæ–‡ä»¶æ˜¯å¦åˆæ³•..."
          cd $GITHUB_WORKSPACE/work/dts_source
          # ç¼–è¯‘æ ¡éªŒå·¥å…·ï¼ˆåˆ©ç”¨libfdtæ£€æŸ¥DTBå¤´éƒ¨å¹»æ•°0xd00dfeedï¼‰
          cat > check_dtb.c << 'EOF'
          #include <libfdt.h>
          #include <stdio.h>
          int main(int argc, char *argv[]) {
            if (argc != 2) return 1;
            void *dtb = fdt_open_into(argv[1], NULL, 0x100000);
            if (!dtb || fdt_check_header(dtb) != 0) {
              printf("âŒ Invalid DTB: %s\n", argv[1]);
              return 1;
            }
            printf("âœ… Valid DTB: %s\n", argv[1]);
            return 0;
          }
          EOF
          gcc check_dtb.c -o check_dtb -lfdt
          # æ‰¹é‡æ ¡éªŒæ‰€æœ‰dtbæ–‡ä»¶
          for dtb_file in *.dtb; do
            ./check_dtb $dtb_file || exit 1
          done
          echo "âœ… æ‰€æœ‰DTBæ–‡ä»¶åˆæ³•æ€§æ ¡éªŒé€šè¿‡ï¼"

      - name: Decompile DTB to DTS + ğŸ” ç¬¬äºŒé‡æ ¡éªŒï¼šDTSè¯­æ³•å®Œæ•´æ€§
        run: |
          echo "âš™ï¸ åç¼–è¯‘dtbâ†’dtså¹¶æ ¡éªŒè¯­æ³•..."
          cd $GITHUB_WORKSPACE/work/dts_source
          for dtb_file in *.dtb; do
            dts_file=${dtb_file%.dtb}.dts
            echo "ğŸ”§ åç¼–è¯‘+æ ¡éªŒ: $dtb_file â†’ $dts_file"
            # åç¼–è¯‘åç«‹å³ç”¨dtcæ ¡éªŒè¯­æ³•ï¼ˆé¿å…æ— æ•ˆè¯­æ³•ï¼‰
            dtc -I dtb -O dts -o $dts_file $dtb_file
            if ! dtc -I dts -O dtb -o /dev/null $dts_file 2>/dev/null; then
              echo "âŒ ERROR: DTSè¯­æ³•é”™è¯¯ï¼æ–‡ä»¶: $dts_file"
              exit 1
            fi
          done
          echo "âœ… æ‰€æœ‰DTSæ–‡ä»¶è¯­æ³•æ ¡éªŒé€šè¿‡ï¼"

      - name: ğŸ” ç¬¬ä¸‰é‡æ ¡éªŒï¼šLineageOSå…¼å®¹æ€§ï¼ˆå…³é”®èŠ‚ç‚¹æ£€æŸ¥ï¼‰
        run: |
          echo "âš™ï¸ éªŒè¯è®¾å¤‡æ ‘æ˜¯å¦å…¼å®¹LineageOSç¼–è¯‘..."
          cd $GITHUB_WORKSPACE/work/dts_source
          # æ£€æŸ¥LineageOSå¿…éœ€çš„æ ¸å¿ƒèŠ‚ç‚¹ï¼ˆç¼ºå¤±ä¼šå¯¼è‡´ç¼–è¯‘å¤±è´¥ï¼‰
          required_nodes=("chosen" "memory" "soc" "aliases")
          for dts_file in *.dts; do
            for node in "${required_nodes[@]}"; do
              if ! grep -q -E "^/{[^}]*$node" $dts_file; then
                echo "âŒ ERROR: ç¼ºå¤±LineageOSå¿…éœ€èŠ‚ç‚¹ '$node'ï¼æ–‡ä»¶: $dts_file"
                exit 1
              fi
            done
          done
          echo "âœ… LineageOSå…¼å®¹æ€§æ ¡éªŒé€šè¿‡ï¼"

      - name: æ„å»ºè®¾å¤‡æ ‘ç›®å½•
        run: |
          echo "âš™ï¸ æ„å»ºæœ€ç»ˆè®¾å¤‡æ ‘ç›®å½•..."
          mkdir -p $GITHUB_WORKSPACE/device_tree
          cp -r $GITHUB_WORKSPACE/work/dts_source/* $GITHUB_WORKSPACE/device_tree/
          [ -d "$GITHUB_WORKSPACE/work/vendor_boot_unpack/ramdisk" ] && cp -r $GITHUB_WORKSPACE/work/vendor_boot_unpack/ramdisk $GITHUB_WORKSPACE/device_tree/
          [ -f "$GITHUB_WORKSPACE/work/vendor_boot_unpack/config" ] && cp $GITHUB_WORKSPACE/work/vendor_boot_unpack/config $GITHUB_WORKSPACE/device_tree/
          echo "âœ… è®¾å¤‡æ ‘æ„å»ºå®Œæˆï¼"

      - name: Cleanå†—ä½™æ–‡ä»¶
        run: |
          rm -rf $GITHUB_WORKSPACE/work $HOME/magiskboot
          find $GITHUB_WORKSPACE/device_tree -name "*.tmp" -delete
          echo "âœ… æ¸…ç†å®Œæˆï¼"

      - name: Commit & Pushè®¾å¤‡æ ‘
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global credential.helper store
          echo "https://github.com:${{ github.actor }}:${{ github.token }}" > ~/.git-credentials
          
          git add device_tree/
          git commit -m "build(device-tree): æå–å¹¶æ ¡éªŒè®¾å¤‡æ ‘ï¼ˆå…¼å®¹LineageOSï¼‰" || echo "â„¹ï¸ æ— æ–°æ–‡ä»¶éœ€æäº¤"
          git push https://${{ github.token }}@github.com/${{ github.repository }}.git HEAD:${GITHUB_REF#refs/heads/} --force-with-lease
          echo "âœ… è®¾å¤‡æ ‘å·²æ¨é€ï¼"