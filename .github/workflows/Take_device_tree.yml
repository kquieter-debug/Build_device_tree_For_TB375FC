name: Extract Vendor_Boot & Build Device Tree For LineageOS

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]
    paths:
      - 'Image/vendor_boot.img'

permissions:
  contents: write
  pull-requests: write
  id-token: write
  actions: read

jobs:
  extract-and-build-dtb:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout current repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ github.token }}
          persist-credentials: true

      - name: Install dependencies & PyPIç‰ˆextract-dtbï¼ˆæ ¸å¿ƒä¿®æ”¹ï¼‰
        run: |
          echo "ğŸ”§ å®‰è£…ç³»ç»Ÿä¾èµ–+PyPIå·¥å…·..."
          sudo apt update -y && sudo apt upgrade -y
          # ç³»ç»ŸåŸºç¡€ä¾èµ–
          sudo apt install -y git wget curl unzip lzip tar gcc g++ make flex bison bc rsync
          sudo apt install -y abootimg android-sdk-libsparse-utils device-tree-compiler libfdt-dev
          # å®‰è£…Pythonç¯å¢ƒ+PyPIç‰ˆextract-dtbï¼ˆå®˜æ–¹æ¨èï¼Œç¨³å®šæ— 404ï¼‰
          sudo apt install -y python3 python3-pip
          pip3 install --upgrade pip
          pip3 install extract-dtb  # ç›´æ¥ä»PyPIå®‰è£…ï¼Œæ›¿ä»£gitä¸‹è½½
          # å®‰è£…Magiskbootï¼ˆè§£åŒ…vendor_bootæ ¸å¿ƒå·¥å…·ï¼‰
          wget --timeout=30 --tries=3 https://github.com/topjohnwu/Magisk/releases/latest/download/magiskboot -O $HOME/magiskboot
          chmod +x $HOME/magiskboot
          echo "âœ… æ‰€æœ‰ä¾èµ–å®‰è£…å®Œæˆï¼"

      - name: Check vendor_boot.img & Create work directories
        run: |
          echo "ğŸ” æ£€æŸ¥Imageç›®å½•..."
          if [ ! -f "Image/vendor_boot.img" ]; then
            echo "âŒ ERROR: Image/vendor_boot.imgä¸å­˜åœ¨ï¼"
            exit 1
          fi
          mkdir -p work/vendor_boot_unpack work/dts_source work/device_tree_out
          echo "âœ… æ–‡ä»¶æ£€æŸ¥é€šè¿‡ï¼"

      - name: Unpack vendor_boot.img + æå–dtbï¼ˆç”¨PyPIç‰ˆextract-dtbï¼‰
        run: |
          echo "âš™ï¸ è§£åŒ…vendor_boot.img..."
          cd work/vendor_boot_unpack
          cp $GITHUB_WORKSPACE/Image/vendor_boot.img ./
          # ç”¨Magiskbootè§£åŒ…é•œåƒ
          $HOME/magiskboot unpack vendor_boot.img
          # ç”¨PyPIç‰ˆextract-dtbæå–dtbï¼ˆå®˜æ–¹å‘½ä»¤ï¼Œæ›´ç¨³å®šï¼‰
          extract-dtb -o $GITHUB_WORKSPACE/work/dts_source/ $GITHUB_WORKSPACE/Image/vendor_boot.img
          # éªŒè¯æå–ç»“æœ
          if [ $(ls $GITHUB_WORKSPACE/work/dts_source/ | wc -l) -eq 0 ]; then
            echo "âŒ ERROR: æœªæå–åˆ°dtbæ–‡ä»¶ï¼"
            exit 1
          fi
          echo "âœ… è§£åŒ…+æå–dtbå®Œæˆï¼"

      - name: Decompile DTB to DTS & æ„å»ºè®¾å¤‡æ ‘
        run: |
          echo "âš™ï¸ åç¼–è¯‘dtbâ†’dts..."
          cd $GITHUB_WORKSPACE/work/dts_source
          for dtb_file in *.dtb; do
            echo "ğŸ”§ åç¼–è¯‘: $dtb_file â†’ ${dtb_file%.dtb}.dts"
            dtc -I dtb -O dts -o ${dtb_file%.dtb}.dts $dtb_file
          done
          # æ„å»ºLineageOSå…¼å®¹çš„è®¾å¤‡æ ‘ç›®å½•
          mkdir -p $GITHUB_WORKSPACE/device_tree
          cp -r $GITHUB_WORKSPACE/work/dts_source/* $GITHUB_WORKSPACE/device_tree/
          [ -d "$GITHUB_WORKSPACE/work/vendor_boot_unpack/ramdisk" ] && cp -r $GITHUB_WORKSPACE/work/vendor_boot_unpack/ramdisk $GITHUB_WORKSPACE/device_tree/
          [ -f "$GITHUB_WORKSPACE/work/vendor_boot_unpack/config" ] && cp $GITHUB_WORKSPACE/work/vendor_boot_unpack/config $GITHUB_WORKSPACE/device_tree/
          echo "âœ… è®¾å¤‡æ ‘æ„å»ºå®Œæˆï¼"

      - name: Cleanå†—ä½™æ–‡ä»¶
        run: |
          echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
          rm -rf $GITHUB_WORKSPACE/work $HOME/magiskboot
          find $GITHUB_WORKSPACE/device_tree -name "*.tmp" -delete
          echo "âœ… æ¸…ç†å®Œæˆï¼"

      - name: Commit & Pushè®¾å¤‡æ ‘ï¼ˆèº«ä»½è®¤è¯ï¼‰
        run: |
          echo "ğŸ“¤ æäº¤è®¾å¤‡æ ‘..."
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global credential.helper store
          echo "https://github.com:${{ github.actor }}:${{ github.token }}" > ~/.git-credentials
          
          git add device_tree/
          git commit -m "build(device-tree): ä»vendor_boot.imgæå–è®¾å¤‡æ ‘" || echo "â„¹ï¸ æ— æ–°æ–‡ä»¶éœ€æäº¤"
          git push https://${{ github.token }}@github.com/${{ github.repository }}.git HEAD:${GITHUB_REF#refs/heads/} --force-with-lease
          echo "âœ… è®¾å¤‡æ ‘å·²æ¨é€è‡³ä»“åº“ï¼"