# å·¥ä½œæµåç§°ï¼Œå¯è‡ªå®šä¹‰
name: Extract Vendor_Boot & Build Device Tree For LineageOS

# è§¦å‘è§„åˆ™ï¼šä¸¤ç§æ–¹å¼å¯é€‰ï¼ŒæŒ‰éœ€å¯ç”¨/æ³¨é‡Š
on:
  # æ–¹å¼1ï¼šæ‰‹åŠ¨åœ¨GitHub Actionsé¡µé¢ç‚¹å‡»ã€ŒRun workflowã€è§¦å‘ï¼Œæ¨èï¼
  workflow_dispatch:
  # æ–¹å¼2ï¼šå½“Imageæ–‡ä»¶å¤¹ä¸­çš„vendor_boot.imgæ›´æ–°æ—¶è‡ªåŠ¨è§¦å‘ï¼ˆæäº¤Image/ç›®å½•æ–‡ä»¶åˆ™è¿è¡Œï¼‰
  push:
    paths:
      - 'Image/vendor_boot.img'

# æƒé™é…ç½®ï¼šå¿…é¡»ç»™å¤Ÿï¼Œç”¨äºæäº¤å’Œæ¨é€è®¾å¤‡æ ‘åˆ°å½“å‰ä»“åº“
permissions:
  contents: write

# è¿è¡Œçš„è™šæ‹Ÿæœºç¯å¢ƒ
jobs:
  extract-and-build-dtb:
    runs-on: ubuntu-latest
    steps:
      # ===================== æ­¥éª¤1ï¼šæ‹‰å–å½“å‰ä»“åº“æ‰€æœ‰ä»£ç åˆ°è¿è¡Œç¯å¢ƒ =====================
      - name: Checkout current repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # æ‹‰å–å®Œæ•´ä»“åº“å†å²ï¼Œé¿å…æäº¤å†²çª

      # ===================== æ­¥éª¤2ï¼šå®‰è£…æ‰€æœ‰å¿…éœ€ä¾èµ–å·¥å…· =====================
      - name: Install all required dependencies & tools
        run: |
          echo "ğŸ”§ å¼€å§‹å®‰è£…ç¼–è¯‘å’Œè§£åŒ…æ‰€éœ€ä¾èµ–..."
          sudo apt update -y && sudo apt upgrade -y
          # åŸºç¡€ä¾èµ–ï¼šè§£åŒ…/ç¼–è¯‘å¿…å¤‡
          sudo apt install -y git wget curl unzip lzip tar gcc g++ make python3 python3-pip flex bison bc rsync
          # Androidè§£åŒ…ä¸“ç”¨å·¥å…·
          sudo apt install -y abootimg android-tools-fsutils simg2img img2simg
          # è®¾å¤‡æ ‘ç¼–è¯‘æ ¸å¿ƒå·¥å…·: dtc (Device Tree Compiler) + libfdt
          sudo apt install -y device-tree-compiler libfdt-dev
          echo "âœ… æ‰€æœ‰ä¾èµ–å®‰è£…å®Œæˆï¼"

      # ===================== æ­¥éª¤3ï¼šä¸‹è½½å®‰å“ä¸“ç”¨è§£åŒ…å·¥å…·åŒ…ï¼ˆvendor_bootä¸“ç”¨ï¼‰ =====================
      - name: Download Android boot/unpack tools (critical for vendor_boot.img)
        run: |
          echo "ğŸ”§ ä¸‹è½½å®‰å“é•œåƒè§£åŒ…ä¸“ç”¨å·¥å…·..."
          # ä¸‹è½½ä¸‡èƒ½bootè§£åŒ…å·¥å…·ï¼ˆå…¼å®¹vendor_boot/boot/init_bootï¼‰
          git clone https://github.com/corsicanu/extract-dtb.git $HOME/extract-dtb
          git clone https://github.com/osm0sis/mkbootimg.git $HOME/mkbootimg
          # ä¸‹è½½magiskbootï¼ˆæœ€å¼ºå®‰å“é•œåƒè§£åŒ…å·¥å…·ï¼Œå¿…è£…ï¼Œå¤„ç†vendor_bootæ ¸å¿ƒï¼‰
          wget https://github.com/topjohnwu/Magisk/releases/latest/download/magiskboot -O $HOME/magiskboot
          chmod +x $HOME/magiskboot $HOME/extract-dtb/extract-dtb.py
          echo "âœ… è§£åŒ…å·¥å…·ä¸‹è½½å®Œæˆï¼"

      # ===================== æ­¥éª¤4ï¼šæ£€æŸ¥vendor_boot.imgæ˜¯å¦å­˜åœ¨ï¼Œåˆ›å»ºå·¥ä½œç›®å½• =====================
      - name: Check vendor_boot.img & Create work directories
        run: |
          echo "ğŸ” æ£€æŸ¥Imageç›®å½•ä¸‹çš„vendor_boot.imgæ–‡ä»¶..."
          # æ£€æŸ¥æ ¸å¿ƒæ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™ç›´æ¥ç»ˆæ­¢å·¥ä½œæµ
          if [ ! -f "Image/vendor_boot.img" ]; then
            echo "âŒ ERROR: Image/vendor_boot.img æ–‡ä»¶ä¸å­˜åœ¨ï¼è¯·ç¡®è®¤æ–‡ä»¶è·¯å¾„æ­£ç¡®"
            exit 1
          fi
          # åˆ›å»ºå·¥ä½œç›®å½•ï¼Œåˆ†ç±»å­˜æ”¾è§£åŒ…æ–‡ä»¶/è®¾å¤‡æ ‘æºæ–‡ä»¶/ç¼–è¯‘åçš„è®¾å¤‡æ ‘
          mkdir -p work/vendor_boot_unpack work/dts_source work/device_tree_out
          echo "âœ… æ–‡ä»¶æ£€æŸ¥é€šè¿‡ï¼Œå·¥ä½œç›®å½•åˆ›å»ºå®Œæˆï¼"

      # ===================== æ­¥éª¤5ï¼šæ ¸å¿ƒæ­¥éª¤ - å®Œæ•´è§£åŒ…vendor_boot.imgé•œåƒ =====================
      - name: Unpack vendor_boot.img completely (all partitions)
        run: |
          echo "âš™ï¸ å¼€å§‹è§£åŒ… vendor_boot.img é•œåƒæ–‡ä»¶..."
          cd work/vendor_boot_unpack
          # å¤åˆ¶ä»“åº“çš„vendor_boot.imgåˆ°å·¥ä½œç›®å½•
          cp $GITHUB_WORKSPACE/Image/vendor_boot.img ./
          # ç¬¬ä¸€æ­¥ï¼šç”¨magiskbootè§£åŒ…vendor_boot.imgï¼ˆæ ¸å¿ƒï¼Œè§£å‡ºå†…æ ¸/ramdisk/dtb/dtboç­‰æ‰€æœ‰åˆ†åŒºï¼‰
          $HOME/magiskboot unpack vendor_boot.img
          # ç¬¬äºŒæ­¥ï¼šæå–æ‰€æœ‰dtbè®¾å¤‡æ ‘äºŒè¿›åˆ¶æ–‡ä»¶åˆ°dts_sourceç›®å½•
          $HOME/extract-dtb/extract-dtb.py vendor_boot.img -o $GITHUB_WORKSPACE/work/dts_source/
          # éªŒè¯è§£åŒ…ç»“æœ
          if [ $(ls $GITHUB_WORKSPACE/work/dts_source/ | wc -l) -eq 0 ]; then
            echo "âŒ ERROR: è§£åŒ…å¤±è´¥ï¼Œæœªæå–åˆ°ä»»ä½•dtbæ–‡ä»¶ï¼"
            exit 1
          fi
          echo "âœ… vendor_boot.img è§£åŒ…å®Œæˆï¼å·²æå–åˆ°dtbäºŒè¿›åˆ¶æ–‡ä»¶"

      # ===================== æ­¥éª¤6ï¼šæ ¸å¿ƒæ­¥éª¤ - åç¼–è¯‘dtbä¸ºdtsæºç  + ç¼–è¯‘æ„å»ºå®Œæ•´è®¾å¤‡æ ‘ =====================
      - name: Decompile DTB to DTS & Build Complet Device Tree (LineageOS Ready)
        run: |
          echo "âš™ï¸ å¼€å§‹åç¼–è¯‘dtbæ–‡ä»¶ä¸ºdtsæºç ï¼Œå¹¶æ„å»ºæ ‡å‡†è®¾å¤‡æ ‘..."
          cd $GITHUB_WORKSPACE/work/dts_source
          # éå†æ‰€æœ‰è§£åŒ…çš„dtbæ–‡ä»¶ï¼Œåç¼–è¯‘ä¸ºå¯è¯»çš„dtsè®¾å¤‡æ ‘æºç ï¼ˆå®‰å“ç¼–è¯‘å¿…é¡»ï¼‰
          for dtb_file in *.dtb; do
            echo "ğŸ”§ åç¼–è¯‘: $dtb_file â†’ ${dtb_file%.dtb}.dts"
            dtc -I dtb -O dts -o ${dtb_file%.dtb}.dts $dtb_file
          done
          # ç¼–è¯‘æ„å»ºæ ‡å‡†è®¾å¤‡æ ‘ç›®å½•ç»“æ„ï¼Œé€‚é…LineageOSç¼–è¯‘è§„èŒƒ
          echo "ğŸ”§ æ„å»ºLineageOSå…¼å®¹çš„è®¾å¤‡æ ‘ç›®å½•..."
          mkdir -p $GITHUB_WORKSPACE/device_tree
          # å¤åˆ¶æ‰€æœ‰dts/dtbæ ¸å¿ƒæ–‡ä»¶åˆ°è®¾å¤‡æ ‘æ ¹ç›®å½•
          cp -r $GITHUB_WORKSPACE/work/dts_source/* $GITHUB_WORKSPACE/device_tree/
          # å¤åˆ¶è§£åŒ…çš„ramdisk/å†…æ ¸é…ç½®ç­‰è¾…åŠ©æ–‡ä»¶ï¼ˆLineageOSç¼–è¯‘éœ€è¦ï¼‰
          cp -r $GITHUB_WORKSPACE/work/vendor_boot_unpack/ramdisk $GITHUB_WORKSPACE/device_tree/
          cp -r $GITHUB_WORKSPACE/work/vendor_boot_unpack/config $GITHUB_WORKSPACE/device_tree/
          echo "âœ… è®¾å¤‡æ ‘æ„å»ºå®Œæˆï¼ç›®å½•: device_tree/ ï¼ˆç›´æ¥å…¼å®¹LineageOSï¼‰"

      # ===================== æ­¥éª¤7ï¼šæ¸…ç†å†—ä½™æ–‡ä»¶ï¼Œä¼˜åŒ–è®¾å¤‡æ ‘ç›®å½• =====================
      - name: Clean redundant files & Optimize device tree structure
        run: |
          echo "ğŸ§¹ æ¸…ç†å†—ä½™æ–‡ä»¶ï¼Œä¼˜åŒ–è®¾å¤‡æ ‘ç›®å½•ç»“æ„..."
          # åˆ é™¤å·¥ä½œç›®å½•ï¼ˆä¸´æ—¶æ–‡ä»¶ï¼Œæ— éœ€æäº¤ï¼‰
          rm -rf $GITHUB_WORKSPACE/work
          # åˆ é™¤è®¾å¤‡æ ‘ä¸­æ— ç”¨çš„ä¸´æ—¶æ–‡ä»¶ï¼Œåªä¿ç•™ç¼–è¯‘å¿…éœ€æ–‡ä»¶
          find $GITHUB_WORKSPACE/device_tree -name "*.tmp" -delete
          find $GITHUB_WORKSPACE/device_tree -name "*.bak" -delete
          echo "âœ… æ¸…ç†å®Œæˆï¼Œè®¾å¤‡æ ‘ç›®å½•çº¯å‡€å¯ç”¨ï¼"

      # ===================== æ­¥éª¤8ï¼šè‡ªåŠ¨æäº¤æ„å»ºå¥½çš„è®¾å¤‡æ ‘åˆ°å½“å‰ä»“åº“ =====================
      - name: Commit & Push Device Tree to Current Repository
        run: |
          echo "ğŸ“¤ å¼€å§‹æäº¤è®¾å¤‡æ ‘æ–‡ä»¶åˆ°ä»“åº“..."
          # é…ç½®gitç”¨æˆ·ä¿¡æ¯ï¼ˆGitHub Actionsä¸“ç”¨ï¼‰
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          # æ·»å»ºè®¾å¤‡æ ‘ç›®å½•åˆ°git
          git add device_tree/
          # æäº¤ä¿¡æ¯ï¼Œå¯è‡ªå®šä¹‰
          git commit -m "build(device-tree): extract and build from vendor_boot.img âœ…" -m "Source: Image/vendor_boot.img" || echo "â„¹ï¸ æ— æ–°çš„è®¾å¤‡æ ‘æ–‡ä»¶éœ€è¦æäº¤"
          # æ¨é€åˆ°å½“å‰ä»“åº“çš„ä¸»åˆ†æ”¯ï¼ˆå¦‚éœ€æ¨é€åˆ°å…¶ä»–åˆ†æ”¯ï¼Œä¿®æ”¹mainä¸ºä½ çš„åˆ†æ”¯åï¼‰
          git push origin main
          echo "âœ… è®¾å¤‡æ ‘å·²æˆåŠŸæ¨é€åˆ°ä»“åº“ï¼ç›®å½•ï¼šdevice_tree/"